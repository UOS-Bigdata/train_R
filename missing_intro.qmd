---
title: "결측값 처리 방법론"
format:
  html:
    toc: true
    embed-resources: true
    fig-cap-location: top
  docx: 
    toc: true
    toc-depth: 2 
    number-sections: true
    reference-doc: custom-reference-doc-landscape.docx
---

# 1. 결측값이란?

## 1.1 결측값의 형태

-   측정 불가/무응답/절단/오류 등으로 데이터에 구멍이 생긴 상태
-   예: 체력 측정하기로 한 운동선수가 갑자기 안 오는 경우
-   예: 임상시험 중 환자가 시험을 중단하는 경우
-   예: 여론조사 전화를 끊어버리는 경우

## 1.2 결측값이 분석에 미치는 영향

-   **표본 크기 감소**: 사용할 수 있는 데이터의 양이 감소하여 분석의 효율성(분산 증가)이 감소
-   **편향**: 관측값과 결측값 간의 체계적인 차이가 발생하는 경우 관측값만으로 계산 된 통계량의 신뢰성에 문제가 생기게 됨
-   부유한 사람일 수록 응답을 하지 않는다는 통계가 존재함
-   나이가 어릴 수록 응답을 하지 않는다는 통계가 존재함
-   여론조사를 생각해보자. 이론적으로 1000개의 표본이 있으면 3%의 오차로 모든 선거를 예측 할 수 있다.

## 1.3 결측값의 분포

-   실제 분포와 결측값의 분포가 다른 경우 분석에 있어 편향이 발생함.

```{r}
set.seed(2026)

n <- 5000
y_true <- rnorm(n, mean = 50, sd = 10)   
p_miss <- plogis((y_true - 50) / 6)      
miss   <- runif(n) < p_miss    

y_obs <- y_true
y_obs[miss] <- NA                       

## 1) 평균 비교
cat("전체(진짜) 평균      :", mean(y_true), "\n")
cat("관측값 평균(observed):", mean(y_obs, na.rm = TRUE), "\n")
cat("결측된 값의 진짜 평균 :", mean(y_true[miss]), "\n")
cat("관측 비율            :", mean(!miss), "\n\n")
```

```{r}

## 2) 히스토그램 비교 (전체 vs 관측값)
op <- par(mfrow = c(1, 2), mar = c(4,4,2,1))

hist(y_true, breaks = 40, main = "True", xlab = "y", col = "grey80", border = "white")
abline(v = mean(y_true), lwd = 2)
mtext(paste0("mean = ", round(mean(y_true), 2)), side = 3, line = -2, adj = 0.05)

hist(y_obs, breaks = 40, main = "Observed", xlab = "y", col = "grey80", border = "white")
abline(v = mean(y_obs, na.rm = TRUE), lwd = 2)
mtext(paste0("mean = ", round(mean(y_obs, na.rm = TRUE), 2)), side = 3, line = -2, adj = 0.05)

par(op)
```

## 1.4 결측 메커니즘

### MCAR(missing completely at random)

-   결측 여부가 관측된 값, 결측된 값과 무관
-   모든 사람이 응답하였는데 그 중 일부가 시스템 오류로 날라감.
-   사람들의 결측이 임의로 발생함

### MAR(missing at radom)

-   결측 여부가 관측된 변수에 의존하고 결측된 값에는 의존하지 않음
-   성별, 연령 등의 변수가 소득 문항 응답률에 영향을 미치는 경우
-   통계학적으로는 MAR 가정을 하고 문제를 푸는 경우가 대부분임.

### MNAR(missing not at random)

-   결측 여부가 결측된 값 자체와 관련 되어있음
-   소득이 높을 수록 소득을 숨김 (실제로 강남권 사람들은 자신들의 소득을 30%까지 underreport 함)

### 문제점:

-   결측 패턴이 MCAR, MAR인 경우 결측값이 있더라도 편향이 없는 분석이 가능
-   효율적인 분산 계산이 가능.
-   실제 대부분의 데이터는 MNAR 상황에 있는 경우가 많으며 MCAR과 MAR은 테스트가 가능하지만, MAR과 MNAR은 테스트가 불가능하다는 것이 수학적으로 증명되었음.
-   MNAR을 해결했다는 것은 어떻게 보면 자기모수적임. 이 결측값의 편향을 제어하기 위해서는 실제값을 알아야만 가능하기 때문.
-   시계열 값이 있는 경우 어느정도 결측값을 보정 할 수 있을 것임.

## 1.5 결측값의 분석

### Complete Case Analysis (CCA)

-   CCA는 분석에 필요한 변수들 중 하나라도 결측(NA)가 있으면 해당하는 행을 모두 제거하고 분석을 수행하는 기법.
-   결측이 임의로 발생했다면, CCA로 만들어낸 통계량은 편향이 없음.
-   각 변수에서 데이터가 결측될 확률이 $p$라고 하고, 변수의 개수는 $q$그리고 데이터의 개수가 $N$개라고 하자. 이때 Complete Case는 평균적으로 $$
    p^q N
    $$
-   각 변수의 결측확률이 30%, 데이터가 10000개, 변수가 10개라고 하자. 이때 Complete Case는 280개이다.
-   편향이 존재하지 않더라도 표본 크기 감소로 인한 분산의 비효율성이 발생함.

### 평균 대체 (mean imputation)

-   결측값을 해당 변수의 관측된 평균으로 채워넣는 방법
-   구현이 매우 쉽고 빠르며, 결측이 임의로 발생하였을 때 편향이 없는 통계량이 생산 가능
-   분산을 과소 추정함. $$
    Var_{imp}(X) < Var_{true}(X)
    $$
-   분산의 과소 추정 문제는 과대 추정보다 훨씬 심각한 문제임. 왜냐하면 분석 자체가 의미있지 않은데 의미있다는 오해석이 발생할 수 있기 때문. $$
    \frac{\hat{\theta} - \theta_0}{\hat{SE}(\hat{\theta})}
    $$
-   신뢰구간 길이의 문제 $$
    \hat{\theta} \pm z_{\alpha/2} \hat{SE}(\hat{\theta})
    $$

### 회귀 대체 (regression imputation)

-   관측된 변수로 회귀모형을 구축한 뒤, 결측된 값에 있는 보조변수로 반응변수 값을 예측하는 방법
-   MCAR, MAR에서 의미있게 작동함
-   분산을 과소 추정하는 문제가 존재하여, 오차를 추가하는 방법이 존재

### 핫덱 대체 (hotdeck imputaiton)

-   관측된 값 들 중에서 눈을 감고 하나의 값을 뽑아 결측된 값을 채워넣는 방법.
-   실제 값을 사용한다는 장점이 존재.
-   결측된 값과 관측된 값이 서로 결측될 환경이 유사하다면 좋은 방법임
-   만약, 체력 측정자의 결측이 성별, 키, 몸무게에 의존하고 우리에게 이 정보가 모두 있다고 가정해보자. 그러면 성별, 키, 몸무게로 나눈 그룹에서 핫덱 대체를 했을 때 편향이 없는 추정치를 생산할 수 있따.

### 성향점수 방법 (propensity score method)

-   데이터가 결측될 확률 $\pi$를 추정하여 $\hat{\pi}$ 데이터의 편향을 보정하는 방법.
-   만약 우리의 추정이 정확하다고 할때 추정의 편향이 없어짐. $$
    \hat{\pi} \overset{p}{\to} \pi
    $$
-   만약, 관측치들 중에서 결측확률이 낮은 사람이 있다면 이들의 중요성을 높여서 편향을 제거하는 방식
-   수식적으로는: $$
    E \left[\sum_{i \in S} \frac{R_i y_i}{\pi_A \pi_B}\right] = E\left[\sum_{i \in U} y_i\right] 
    $$ \### 다중대체 (multiple imputation)
-   회귀 대체, 핫덱 대체 등으로 발생하는 분산의 과소 추정을 해결하기 위해 임의적으로 분산을 팽창시키는 방법
-   수학적으로 매우 복잡, 데이터 마다 flag를 만들어줘야함.

### 1.6 실무적 결측값 처리

-   결측 메커니즘이 뭐가 되었던 간에 보고서는 작성 되어야함! =\> 가능한 편향을 없애자.
-   우리에게 주어진 보조변수를 기준으로 편향이 발생하는지를 분석 (히스토그램, 빈도표 등을 사용)
-   편향을 유발하는 변수들에 대해 그룹핑을 해서 핫덱 대체(실제값을 대체하는 것이 중요한 경우)
-   편향을 유발하는 변수들에 대해 그룹핑을 해서 평균 대체
-   회귀 대체 등의 방법이 현실적임.
-   결국은 분산이 문제인데 이는 다중대체 방법(MICE 패키지)를 이용하여 보정이 가능.
